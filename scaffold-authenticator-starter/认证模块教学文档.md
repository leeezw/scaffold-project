# ç™»å½•è®¤è¯æ¨¡å—æ•™å­¦æ–‡æ¡£

## ğŸ“š ç›®å½•

1. [æ¶æ„æ¦‚è¿°](#æ¶æ„æ¦‚è¿°)
2. [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
3. [è®¤è¯æµç¨‹](#è®¤è¯æµç¨‹)
4. [ä»£ç ç¤ºä¾‹](#ä»£ç ç¤ºä¾‹)
5. [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
6. [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)
7. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## æ¶æ„æ¦‚è¿°

### è®¾è®¡ç†å¿µ

æœ¬è®¤è¯æ¨¡å—é‡‡ç”¨**åˆ†å±‚æ¶æ„**å’Œ**è´£ä»»é“¾æ¨¡å¼**ï¼Œå°†è®¤è¯é€»è¾‘è§£è€¦ä¸ºå¤šä¸ªç‹¬ç«‹çš„ç»„ä»¶ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Controller å±‚                         â”‚
â”‚              (AuthController - ç™»å½•æ¥å£)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              AuthenticationFilter                       â”‚
â”‚          (è¿‡æ»¤å™¨ - æ‹¦æˆªè¯·æ±‚ï¼ŒéªŒè¯ Token)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              DefaultSecurityManager                     â”‚
â”‚          (è®¤è¯ç®¡ç†å™¨ - æ ¸å¿ƒè®¤è¯é€»è¾‘)                      â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                               â”‚
      â–¼                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Realm     â”‚              â”‚   Signature  â”‚
â”‚ (è·å–ç”¨æˆ·ä¿¡æ¯) â”‚              â”‚  (JWTç­¾åéªŒè¯) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         AuthenticationService (ä¸šåŠ¡å±‚å®ç°)               â”‚
â”‚          (éªŒè¯ç”¨æˆ·åå¯†ç ï¼Œè·å–ç”¨æˆ·ä¿¡æ¯)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç‰¹æ€§

- âœ… **JWT Token è®¤è¯**ï¼šæ— çŠ¶æ€è®¤è¯ï¼Œæ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²
- âœ… **Session ç®¡ç†**ï¼šåŸºäº Redis çš„ä¼šè¯ç®¡ç†ï¼Œæ”¯æŒè®¾å¤‡éªŒè¯
- âœ… **æƒé™æ§åˆ¶**ï¼šåŸºäºæ³¨è§£çš„æƒé™å’Œè§’è‰²æ§åˆ¶
- âœ… **è‡ªåŠ¨é…ç½®**ï¼šSpring Boot Starter è‡ªåŠ¨é…ç½®ï¼Œå¼€ç®±å³ç”¨
- âœ… **çµæ´»æ‰©å±•**ï¼šæ”¯æŒè‡ªå®šä¹‰ Realmã€Signature ç­‰ç»„ä»¶

---

## æ ¸å¿ƒç»„ä»¶

### 1. Authenticatorï¼ˆè®¤è¯å™¨ï¼‰

**æ¥å£å®šä¹‰**ï¼š`com.kite.authenticator.Authenticator`

**èŒè´£**ï¼šè®¤è¯çš„æ ¸å¿ƒæ¥å£ï¼Œè´Ÿè´£ç™»å½•å’Œè®¤è¯ä¸¤ä¸ªæ ¸å¿ƒåŠŸèƒ½ã€‚

```java
public interface Authenticator {
    // ç™»å½•ï¼šç”Ÿæˆ Token
    String login(AuthenticationInfo authenticationInfo);
    
    // è®¤è¯ï¼šéªŒè¯ Token
    LoginUser authenticate(HostAuthenticationToken token);
}
```

**å®ç°ç±»**ï¼š`DefaultSecurityManager`

**å…³é”®æ–¹æ³•**ï¼š
- `login()`: ç”¨æˆ·ç™»å½•æ—¶è°ƒç”¨ï¼Œç”Ÿæˆ JWT Token å¹¶åˆ›å»º Session
- `authenticate()`: æ¯æ¬¡è¯·æ±‚æ—¶è°ƒç”¨ï¼ŒéªŒè¯ Token å¹¶è¿”å›ç”¨æˆ·ä¿¡æ¯

---

### 2. Realmï¼ˆè®¤è¯åŸŸï¼‰

**æ¥å£å®šä¹‰**ï¼š`com.kite.authenticator.Realm`

**èŒè´£**ï¼šä» Token ä¸­è§£æç”¨æˆ·ä¿¡æ¯ï¼Œæ˜¯è®¤è¯çš„æ•°æ®æºã€‚

```java
public interface Realm {
    // åˆ¤æ–­æ˜¯å¦æ”¯æŒè¯¥ç±»å‹çš„ Token
    boolean support(AuthenticationToken token);
    
    // è·å–è®¤è¯ä¿¡æ¯ï¼ˆä» Token ä¸­è§£æç”¨æˆ·ä¿¡æ¯ï¼‰
    AuthenticationInfo getAuthenticationInfo(AuthenticationToken token);
}
```

**å®ç°ç±»**ï¼š
- `UserRealm`: ä» JWT Token ä¸­è§£æç”¨æˆ·ä¿¡æ¯
- `EmptyRealm`: ç©ºå®ç°ï¼Œç”¨äºæµ‹è¯•

**å·¥ä½œæµç¨‹**ï¼š
```
Token â†’ UserRealm â†’ è§£æ JWT â†’ æå–ç”¨æˆ·ä¿¡æ¯ â†’ AuthenticationInfo
```

---

### 3. Signatureï¼ˆç­¾åå™¨ï¼‰

**æ¥å£å®šä¹‰**ï¼š`com.kite.authenticator.Signature`

**èŒè´£**ï¼šè´Ÿè´£ JWT Token çš„ç­¾åå’ŒéªŒè¯ã€‚

```java
public interface Signature {
    // ç­¾åï¼šç”Ÿæˆ Token
    String sign(LoginUser loginUser, String secret);
    
    // éªŒè¯ï¼šéªŒè¯ Token å¹¶è¿”å›ç”¨æˆ·ä¿¡æ¯
    LoginUser verify(String token, String secret);
}
```

**å®ç°ç±»**ï¼š`JwtHmacSignature`

**ç®—æ³•**ï¼šHMAC-SHA256

---

### 4. AuthenticationFilterï¼ˆè®¤è¯è¿‡æ»¤å™¨ï¼‰

**ç±»å®šä¹‰**ï¼š`com.kite.authenticator.filter.AuthenticationFilter`

**èŒè´£**ï¼šæ‹¦æˆªæ‰€æœ‰ HTTP è¯·æ±‚ï¼ŒéªŒè¯ Tokenï¼Œè®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡ã€‚

**å·¥ä½œæµç¨‹**ï¼š
```
è¯·æ±‚åˆ°è¾¾ â†’ æ£€æŸ¥æ’é™¤è·¯å¾„ â†’ æå– Token â†’ è°ƒç”¨ Authenticator è®¤è¯ 
â†’ è®¾ç½® LoginUserContext â†’ ç»§ç»­è¯·æ±‚ â†’ æ¸…ç†ä¸Šä¸‹æ–‡
```

**å…³é”®ç‰¹æ€§**ï¼š
- æ”¯æŒæ’é™¤è·¯å¾„é…ç½®ï¼ˆå¦‚ç™»å½•æ¥å£ã€æ–‡æ¡£æ¥å£ï¼‰
- æ”¯æŒ Mock æ¨¡å¼ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
- è‡ªåŠ¨æå–è®¾å¤‡IDï¼ˆä» Header æˆ– User-Agentï¼‰

---

### 5. SessionManagerï¼ˆä¼šè¯ç®¡ç†å™¨ï¼‰

**ç±»å®šä¹‰**ï¼š`com.kite.authenticator.session.SessionManager`

**èŒè´£**ï¼šç®¡ç†ç”¨æˆ·ä¼šè¯ï¼Œæ”¯æŒå¤šè®¾å¤‡ç™»å½•ã€å¼ºåˆ¶ä¸‹çº¿ç­‰åŠŸèƒ½ã€‚

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- åˆ›å»º Sessionï¼ˆç™»å½•æ—¶ï¼‰
- è·å– Sessionï¼ˆè®¤è¯æ—¶ï¼‰
- æ›´æ–° Sessionï¼ˆç»­æœŸï¼‰
- åˆ é™¤ Sessionï¼ˆç™»å‡ºï¼‰
- å¼ºåˆ¶ä¸‹çº¿ç”¨æˆ·æˆ–è®¾å¤‡

**å­˜å‚¨æ–¹å¼**ï¼šåŸºäº Redisï¼ˆ`RedisSessionDao`ï¼‰

---

### 6. LoginUserContextï¼ˆç”¨æˆ·ä¸Šä¸‹æ–‡ï¼‰

**ç±»å®šä¹‰**ï¼š`com.kite.authenticator.context.LoginUserContext`

**èŒè´£**ï¼šä½¿ç”¨ ThreadLocal å­˜å‚¨å½“å‰è¯·æ±‚çš„ç™»å½•ç”¨æˆ·ä¿¡æ¯ã€‚

**ä½¿ç”¨æ–¹å¼**ï¼š
```java
// è·å–å½“å‰ç™»å½•ç”¨æˆ·
LoginUser loginUser = LoginUserContext.getLoginUser();

// è·å–ç”¨æˆ·ID
Long userId = LoginUserContext.getUserId();

// è·å–ç”¨æˆ·å
String username = LoginUserContext.getUsername();
```

**ç”Ÿå‘½å‘¨æœŸ**ï¼š
- åœ¨ `AuthenticationFilter` ä¸­è®¾ç½®ï¼ˆè®¤è¯æˆåŠŸåï¼‰
- åœ¨è¯·æ±‚ç»“æŸåè‡ªåŠ¨æ¸…ç†

---

### 7. AuthenticationServiceï¼ˆè®¤è¯æœåŠ¡ï¼‰

**æ¥å£å®šä¹‰**ï¼š`com.kite.authenticator.service.AuthenticationService`

**èŒè´£**ï¼šä¸šåŠ¡å±‚éœ€è¦å®ç°çš„æ¥å£ï¼Œæä¾›ç”¨æˆ·è®¤è¯é€»è¾‘ã€‚

```java
public interface AuthenticationService {
    // æ ¹æ®ç”¨æˆ·åå¯†ç è®¤è¯
    LoginUser authenticate(String username, String password);
    
    // æ ¹æ®ç”¨æˆ·IDè·å–ç”¨æˆ·ä¿¡æ¯
    LoginUser getUserById(Long userId);
}
```

**å®ç°ç¤ºä¾‹**ï¼š`com.kite.usercenter.service.impl.AuthenticationServiceImpl`

---

## è®¤è¯æµç¨‹

### 1. ç™»å½•æµç¨‹

```
ç”¨æˆ·è¯·æ±‚ç™»å½•
    â†“
AuthController.login()
    â†“
AuthenticationService.authenticate() éªŒè¯ç”¨æˆ·åå¯†ç 
    â†“
åˆ›å»º AuthenticationInfoï¼ˆåŒ…å« LoginUser å’Œè®¾å¤‡IDï¼‰
    â†“
Authenticator.login()
    â†“
SessionManager.createSession() åˆ›å»º Sessionï¼ˆå­˜å‚¨åˆ° Redisï¼‰
    â†“
Signature.sign() ç”Ÿæˆ JWT Tokenï¼ˆåŒ…å« sessionKeyï¼‰
    â†“
è¿”å› Token ç»™å®¢æˆ·ç«¯
```

**æ—¶åºå›¾**ï¼š
```
Client          AuthController    AuthService    Authenticator    SessionManager    Redis
  â”‚                   â”‚                â”‚              â”‚                  â”‚              â”‚
  â”‚â”€â”€POST /loginâ”€â”€â”€â”€â”€â”€>â”‚                â”‚              â”‚                  â”‚              â”‚
  â”‚                   â”‚â”€â”€authenticateâ”€>â”‚              â”‚                  â”‚              â”‚
  â”‚                   â”‚<â”€â”€LoginUserâ”€â”€â”€â”€â”‚              â”‚                  â”‚              â”‚
  â”‚                   â”‚                â”‚              â”‚                  â”‚              â”‚
  â”‚                   â”‚â”€â”€loginâ”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚                  â”‚              â”‚
  â”‚                   â”‚                â”‚              â”‚â”€â”€createSessionâ”€â”€â”€>â”‚              â”‚
  â”‚                   â”‚                â”‚              â”‚                  â”‚â”€â”€saveâ”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                   â”‚                â”‚              â”‚<â”€â”€sessionKeyâ”€â”€â”€â”€â”€â”€â”€â”‚              â”‚
  â”‚                   â”‚                â”‚â”€â”€sign()â”€â”€â”€â”€â”€â”€>â”‚                  â”‚              â”‚
  â”‚                   â”‚<â”€â”€Tokenâ”€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚                  â”‚              â”‚
  â”‚<â”€â”€Tokenâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚              â”‚                  â”‚              â”‚
```

### 2. è¯·æ±‚è®¤è¯æµç¨‹

```
HTTP è¯·æ±‚åˆ°è¾¾
    â†“
AuthenticationFilter.doFilter()
    â†“
æ£€æŸ¥æ’é™¤è·¯å¾„ï¼ˆå¦‚ /api/auth/loginï¼‰
    â†“
æå– Tokenï¼ˆä» Header æˆ– Cookieï¼‰
    â†“
åˆ›å»º HostAuthenticationTokenï¼ˆåŒ…å« Token å’Œè®¾å¤‡IDï¼‰
    â†“
Authenticator.authenticate()
    â†“
Realm.getAuthenticationInfo() ä» Token è§£æç”¨æˆ·ä¿¡æ¯
    â†“
Signature.verify() éªŒè¯ Token ç­¾å
    â†“
SessionManager.getSession() è·å– Sessionï¼ˆéªŒè¯è®¾å¤‡ã€çŠ¶æ€ã€è¶…æ—¶ï¼‰
    â†“
è®¾ç½® LoginUserContext.setLoginUser()
    â†“
ç»§ç»­è¯·æ±‚å¤„ç†
    â†“
è¯·æ±‚ç»“æŸåæ¸…ç† LoginUserContext.clear()
```

**æ—¶åºå›¾**ï¼š
```
Client          Filter          Authenticator    Realm          Signature    SessionManager    Redis
  â”‚               â”‚                  â”‚              â”‚              â”‚              â”‚              â”‚
  â”‚â”€â”€Requestâ”€â”€â”€â”€â”€>â”‚                  â”‚              â”‚              â”‚              â”‚              â”‚
  â”‚               â”‚â”€â”€extractToken()â”€â”€>â”‚              â”‚              â”‚              â”‚              â”‚
  â”‚               â”‚                  â”‚â”€â”€authenticate()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚              â”‚
  â”‚               â”‚                  â”‚              â”‚â”€â”€getAuthInfo()â”€>â”‚              â”‚              â”‚
  â”‚               â”‚                  â”‚              â”‚              â”‚â”€â”€verify()â”€â”€â”€â”€â”€>â”‚              â”‚
  â”‚               â”‚                  â”‚              â”‚              â”‚              â”‚â”€â”€getSession()â”€>â”‚
  â”‚               â”‚                  â”‚              â”‚              â”‚              â”‚<â”€â”€Sessionâ”€â”€â”€â”€â”€â”‚
  â”‚               â”‚â”€â”€setContext()â”€â”€â”€>â”‚              â”‚              â”‚              â”‚              â”‚
  â”‚               â”‚â”€â”€doFilter()â”€â”€â”€â”€â”€>â”‚              â”‚              â”‚              â”‚              â”‚
  â”‚               â”‚                  â”‚              â”‚              â”‚              â”‚              â”‚
  â”‚<â”€â”€Responseâ”€â”€â”€â”€â”‚                  â”‚              â”‚              â”‚              â”‚              â”‚
  â”‚               â”‚â”€â”€clearContext()â”€â”€>â”‚              â”‚              â”‚              â”‚              â”‚
```

### 3. æƒé™æ£€æŸ¥æµç¨‹

```
Controller æ–¹æ³•æ‰§è¡Œ
    â†“
PermissionAspect.checkPermission()ï¼ˆAOP æ‹¦æˆªï¼‰
    â†“
æ£€æŸ¥ @RequiresRoles æˆ– @RequiresPermissions æ³¨è§£
    â†“
ä» LoginUserContext è·å–å½“å‰ç”¨æˆ·
    â†“
éªŒè¯ç”¨æˆ·è§’è‰²/æƒé™
    â†“
é€šè¿‡ â†’ ç»§ç»­æ‰§è¡Œæ–¹æ³•
å¤±è´¥ â†’ æŠ›å‡º BusinessExceptionï¼ˆ403 Forbiddenï¼‰
```

---

## ä»£ç ç¤ºä¾‹

### 1. å®ç° AuthenticationService

```java
@Service
public class AuthenticationServiceImpl implements AuthenticationService {
    
    @Autowired
    private UserService userService;
    
    @Autowired
    private UserRoleMapper userRoleMapper;
    
    @Autowired
    private RoleMapper roleMapper;
    
    @Override
    public LoginUser authenticate(String username, String password) {
        // 1. æŸ¥è¯¢ç”¨æˆ·
        User user = userService.findByUsername(username);
        if (user == null || user.getStatus() == 0) {
            throw new BusinessException("è´¦å·ä¸å­˜åœ¨æˆ–å·²è¢«ç¦ç”¨");
        }
        
        // 2. éªŒè¯å¯†ç 
        if (!PasswordUtils.matches(password, user.getPassword())) {
            throw new BusinessException("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
        }
        
        // 3. æ„å»º LoginUser
        return buildLoginUser(user);
    }
    
    @Override
    public LoginUser getUserById(Long userId) {
        User user = userService.getById(userId);
        if (user == null) {
            return null;
        }
        return buildLoginUser(user);
    }
    
    private LoginUser buildLoginUser(User user) {
        LoginUser loginUser = new LoginUser();
        loginUser.setUserId(user.getId());
        loginUser.setUsername(user.getUsername());
        loginUser.setNickname(user.getNickname());
        
        // æŸ¥è¯¢è§’è‰²
        List<Long> roleIds = userRoleMapper.listRoleIdsByUserId(user.getId());
        List<Role> roles = roleMapper.selectByIds(roleIds);
        loginUser.setRoles(roles.stream().map(Role::getCode).collect(Collectors.toList()));
        
        // æŸ¥è¯¢æƒé™
        // ... æŸ¥è¯¢æƒé™é€»è¾‘
        
        return loginUser;
    }
}
```

### 2. ç™»å½•æ¥å£

```java
@RestController
@RequestMapping("/api/auth")
@AllowAnonymous  // å…è®¸åŒ¿åè®¿é—®
public class AuthController {
    
    @Autowired
    private AuthenticationService authenticationService;
    
    @Autowired
    private Authenticator authenticator;
    
    @PostMapping("/login")
    public Result<Map<String, Object>> login(@RequestBody LoginRequest request,
                                             HttpServletRequest httpRequest) {
        // 1. éªŒè¯ç”¨æˆ·åå¯†ç 
        LoginUser loginUser = authenticationService.authenticate(
            request.getUsername(), 
            request.getPassword()
        );
        
        // 2. æå–è®¾å¤‡ID
        String deviceId = extractDeviceId(httpRequest);
        
        // 3. åˆ›å»ºè®¤è¯ä¿¡æ¯
        AuthenticationInfo authInfo = new AuthenticationInfo() {
            @Override
            public LoginUser getUser() {
                return loginUser;
            }
            
            @Override
            public String getCredential() {
                return deviceId;  // è®¾å¤‡IDä½œä¸ºå‡­è¯
            }
        };
        
        // 4. è°ƒç”¨è®¤è¯å™¨ç™»å½•
        String token = authenticator.login(authInfo);
        
        // 5. è¿”å›ç»“æœ
        Map<String, Object> result = new HashMap<>();
        result.put("token", token);
        result.put("user", loginUser);
        return Result.success(result);
    }
    
    private String extractDeviceId(HttpServletRequest request) {
        String deviceId = request.getHeader("X-Device-Id");
        if (deviceId == null || deviceId.isEmpty()) {
            String userAgent = request.getHeader("User-Agent");
            deviceId = userAgent != null ? String.valueOf(userAgent.hashCode()) : "default";
        }
        return deviceId;
    }
}
```

### 3. ä½¿ç”¨å‚æ•°è§£æå™¨ï¼ˆè‡ªåŠ¨æ³¨å…¥ LoginUserï¼‰

```java
@RestController
@RequestMapping("/api/users")
public class UserController {
    
    // LoginUser ä¼šè‡ªåŠ¨ä» LoginUserContext ä¸­æ³¨å…¥
    @GetMapping("/current")
    public Result<LoginUser> getCurrentUser(LoginUser loginUser) {
        return Result.success(loginUser);
    }
    
    // æˆ–è€…ä½¿ç”¨ LoginUserContext å·¥å…·ç±»
    @GetMapping("/profile")
    public Result<Map<String, Object>> getProfile() {
        Long userId = LoginUserContext.getUserId();
        String username = LoginUserContext.getUsername();
        
        Map<String, Object> profile = new HashMap<>();
        profile.put("userId", userId);
        profile.put("username", username);
        return Result.success(profile);
    }
}
```

### 4. æƒé™æ§åˆ¶

```java
@RestController
@RequestMapping("/api/users")
public class UserController {
    
    // éœ€è¦ user:list æƒé™
    @RequiresPermissions("user:list")
    @GetMapping("/list")
    public Result<List<UserDTO>> listUsers() {
        // ...
    }
    
    // éœ€è¦ admin è§’è‰²
    @RequiresRoles("admin")
    @DeleteMapping("/{id}")
    public Result<Void> deleteUser(@PathVariable Long id) {
        // ...
    }
    
    // éœ€è¦ user:create æˆ– user:update æƒé™ï¼ˆOR é€»è¾‘ï¼‰
    @RequiresPermissions(value = {"user:create", "user:update"}, logical = Logical.OR)
    @PostMapping
    public Result<Void> saveUser(@RequestBody UserDTO user) {
        // ...
    }
    
    // éœ€è¦ admin å’Œ manager ä¸¤ä¸ªè§’è‰²ï¼ˆAND é€»è¾‘ï¼‰
    @RequiresRoles(value = {"admin", "manager"}, logical = Logical.AND)
    @GetMapping("/admin")
    public Result<List<UserDTO>> adminList() {
        // ...
    }
}
```

### 5. å…è®¸åŒ¿åè®¿é—®

```java
// ç±»çº§åˆ«ï¼šæ•´ä¸ª Controller å…è®¸åŒ¿åè®¿é—®
@AllowAnonymous
@RestController
@RequestMapping("/api/public")
public class PublicController {
    // ...
}

// æ–¹æ³•çº§åˆ«ï¼šå•ä¸ªæ–¹æ³•å…è®¸åŒ¿åè®¿é—®
@RestController
@RequestMapping("/api/auth")
public class AuthController {
    
    @AllowAnonymous
    @PostMapping("/login")
    public Result<String> login() {
        // ...
    }
    
    @GetMapping("/current")  // éœ€è¦è®¤è¯
    public Result<LoginUser> getCurrentUser() {
        // ...
    }
}
```

---

## é…ç½®è¯´æ˜

### application.yml é…ç½®

```yaml
# è®¤è¯é…ç½®
kite:
  auth:
    enabled: true                    # æ˜¯å¦å¯ç”¨è®¤è¯ï¼ˆé»˜è®¤ï¼štrueï¼‰
    token-header: Authorization      # Token Header åç§°
    token-prefix: Bearer             # Token å‰ç¼€
    secret: your-secret-key          # JWT å¯†é’¥ï¼ˆè¯·ä¿®æ”¹ä¸ºå®‰å…¨çš„å¯†é’¥ï¼‰
    expire-time: 604800000          # Token è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼Œé»˜è®¤ 7 å¤©
    mock-enabled: false              # æ˜¯å¦å¯ç”¨ Mock ç”¨æˆ·ï¼ˆå¼€å‘ç¯å¢ƒä½¿ç”¨ï¼‰
    mock-user-id: 1                  # Mock ç”¨æˆ·ID
    mock-username: mock-user         # Mock ç”¨æˆ·å
    check-permission: true           # æ˜¯å¦éªŒè¯æƒé™
    exclude-paths:                   # æ’é™¤è·¯å¾„ï¼ˆä¸éœ€è¦è®¤è¯çš„è·¯å¾„ï¼‰
      - /api/hello
      - /api/auth/login
      - /api/auth/register
      - /doc.html
      - /swagger-ui/**
      - /v3/api-docs/**
      - /druid/**
    session:                          # Session é…ç½®
      enabled: true                   # æ˜¯å¦å¯ç”¨ Session ç®¡ç†ï¼ˆé»˜è®¤ï¼štrueï¼‰
      validate-device: true           # æ˜¯å¦éªŒè¯è®¾å¤‡ï¼ˆé»˜è®¤ï¼štrueï¼‰
      validate-status: true           # æ˜¯å¦éªŒè¯ç”¨æˆ·çŠ¶æ€ï¼ˆé»˜è®¤ï¼štrueï¼‰
      renewal: true                   # æ˜¯å¦å¯ç”¨ Session ç»­æœŸï¼ˆé»˜è®¤ï¼štrueï¼‰
      timeout: 1800000               # Session è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼Œé»˜è®¤ï¼š30åˆ†é’Ÿï¼‰
      renewal-interval: 604800000     # Session ç»­æœŸé—´éš”ï¼ˆæ¯«ç§’ï¼Œé»˜è®¤ï¼š7å¤©ï¼‰
```

### é…ç½®é¡¹è¯´æ˜

| é…ç½®é¡¹ | è¯´æ˜ | é»˜è®¤å€¼ |
|--------|------|--------|
| `enabled` | æ˜¯å¦å¯ç”¨è®¤è¯æ¡†æ¶ | `true` |
| `token-header` | Token åœ¨ HTTP Header ä¸­çš„åç§° | `Authorization` |
| `token-prefix` | Token å‰ç¼€ï¼ˆå¦‚ Bearerï¼‰ | `Bearer` |
| `secret` | JWT ç­¾åå¯†é’¥ï¼ˆ**å¿…é¡»ä¿®æ”¹**ï¼‰ | - |
| `expire-time` | Token è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ | `604800000` (7å¤©) |
| `mock-enabled` | Mock æ¨¡å¼ï¼ˆå¼€å‘ç¯å¢ƒï¼‰ | `false` |
| `exclude-paths` | æ’é™¤è·¯å¾„åˆ—è¡¨ | - |
| `session.enabled` | æ˜¯å¦å¯ç”¨ Session | `true` |
| `session.validate-device` | æ˜¯å¦éªŒè¯è®¾å¤‡ | `true` |
| `session.timeout` | Session è¶…æ—¶æ—¶é—´ | `1800000` (30åˆ†é’Ÿ) |

---

## ä½¿ç”¨æŒ‡å—

### 1. å¿«é€Ÿå¼€å§‹

#### æ­¥éª¤ 1ï¼šæ·»åŠ ä¾èµ–

```xml
<dependency>
    <groupId>com.kite</groupId>
    <artifactId>scaffold-authenticator-starter</artifactId>
    <version>1.0.0-SNAPSHOT</version>
</dependency>
```

#### æ­¥éª¤ 2ï¼šå®ç° AuthenticationService

```java
@Service
public class MyAuthenticationService implements AuthenticationService {
    @Override
    public LoginUser authenticate(String username, String password) {
        // å®ç°è®¤è¯é€»è¾‘
    }
    
    @Override
    public LoginUser getUserById(Long userId) {
        // å®ç°è·å–ç”¨æˆ·é€»è¾‘
    }
}
```

#### æ­¥éª¤ 3ï¼šé…ç½® application.yml

```yaml
kite:
  auth:
    enabled: true
    secret: your-secret-key
```

#### æ­¥éª¤ 4ï¼šåˆ›å»ºç™»å½•æ¥å£

```java
@RestController
@RequestMapping("/api/auth")
@AllowAnonymous
public class AuthController {
    @Autowired
    private AuthenticationService authenticationService;
    
    @Autowired
    private Authenticator authenticator;
    
    @PostMapping("/login")
    public Result<String> login(@RequestBody LoginRequest request) {
        LoginUser loginUser = authenticationService.authenticate(
            request.getUsername(), 
            request.getPassword()
        );
        
        AuthenticationInfo authInfo = new AuthenticationInfo() {
            @Override
            public LoginUser getUser() {
                return loginUser;
            }
            
            @Override
            public String getCredential() {
                return "device-id";
            }
        };
        
        String token = authenticator.login(authInfo);
        return Result.success(token);
    }
}
```

### 2. å®¢æˆ·ç«¯ä½¿ç”¨ Token

#### æ–¹å¼ 1ï¼šä½¿ç”¨ Headerï¼ˆæ¨èï¼‰

```javascript
// JavaScript / Axios
axios.get('/api/users/current', {
    headers: {
        'Authorization': 'Bearer ' + token
    }
});
```

```java
// Java / OkHttp
Request request = new Request.Builder()
    .url("http://api.example.com/users/current")
    .addHeader("Authorization", "Bearer " + token)
    .build();
```

#### æ–¹å¼ 2ï¼šä½¿ç”¨ Cookie

Token ä¼šè‡ªåŠ¨ä» Cookie ä¸­è¯»å–ï¼ˆå¦‚æœé…ç½®äº† Cookie åç§°ï¼‰ã€‚

### 3. è·å–å½“å‰ç™»å½•ç”¨æˆ·

#### æ–¹å¼ 1ï¼šä½¿ç”¨å‚æ•°è§£æå™¨ï¼ˆæ¨èï¼‰

```java
@GetMapping("/current")
public Result<LoginUser> getCurrentUser(LoginUser loginUser) {
    return Result.success(loginUser);
}
```

#### æ–¹å¼ 2ï¼šä½¿ç”¨ LoginUserContext

```java
@GetMapping("/profile")
public Result<Map<String, Object>> getProfile() {
    LoginUser loginUser = LoginUserContext.getLoginUser();
    Long userId = LoginUserContext.getUserId();
    String username = LoginUserContext.getUsername();
    // ...
}
```

### 4. æƒé™æ§åˆ¶

#### ä½¿ç”¨ @RequiresPermissions

```java
@RequiresPermissions("user:list")
@GetMapping("/users")
public Result<List<User>> listUsers() {
    // ...
}
```

#### ä½¿ç”¨ @RequiresRoles

```java
@RequiresRoles("admin")
@DeleteMapping("/users/{id}")
public Result<Void> deleteUser(@PathVariable Long id) {
    // ...
}
```

### 5. Session ç®¡ç†

```java
@Autowired
private SessionManager sessionManager;

// å¼ºåˆ¶ç”¨æˆ·ä¸‹çº¿
sessionManager.kickOutUser(userId);

// å¼ºåˆ¶è®¾å¤‡ä¸‹çº¿
sessionManager.kickOutDevice(userId, deviceId);

// è·å–ç”¨æˆ·çš„æ‰€æœ‰ Session
Set<String> sessionKeys = sessionManager.getUserSessionKeys(userId);
```

---

## å¸¸è§é—®é¢˜

### Q1: Token åœ¨å“ªé‡Œå­˜å‚¨ï¼Ÿ

**A**: Token ç”±å®¢æˆ·ç«¯å­˜å‚¨ï¼ˆé€šå¸¸å­˜å‚¨åœ¨ localStorage æˆ– sessionStorageï¼‰ï¼Œæ¯æ¬¡è¯·æ±‚æ—¶é€šè¿‡ Header å‘é€ã€‚

### Q2: Session å’Œ Token çš„å…³ç³»ï¼Ÿ

**A**: 
- **Token**: ç”¨äºæ— çŠ¶æ€è®¤è¯ï¼ŒåŒ…å«ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
- **Session**: å­˜å‚¨åœ¨ Redis ä¸­ï¼Œç”¨äºè®¾å¤‡éªŒè¯ã€çŠ¶æ€ç®¡ç†ã€å¼ºåˆ¶ä¸‹çº¿ç­‰åŠŸèƒ½
- Token ä¸­åŒ…å« `sessionKey`ï¼Œç”¨äºå…³è” Session

### Q3: å¦‚ä½•å®ç°å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰ï¼Ÿ

**A**: å¤šä¸ªåº”ç”¨å…±äº«åŒä¸€ä¸ª Redis å’Œ JWT å¯†é’¥å³å¯å®ç° SSOã€‚

### Q4: å¦‚ä½•å®ç°è®°ä½æˆ‘åŠŸèƒ½ï¼Ÿ

**A**: ç™»å½•æ—¶æ ¹æ®"è®°ä½æˆ‘"é€‰é¡¹è®¾ç½®ä¸åŒçš„ `expire-time`ï¼ˆå¦‚ 7 å¤©æˆ– 30 å¤©ï¼‰ã€‚

### Q5: å¦‚ä½•åˆ·æ–° Tokenï¼Ÿ

**A**: å½“å‰å®ç°ä¸­ï¼ŒSession ä¼šè‡ªåŠ¨ç»­æœŸã€‚å¦‚æœéœ€è¦åˆ·æ–° Tokenï¼Œå¯ä»¥å®ç°ä¸€ä¸ªåˆ·æ–°æ¥å£ï¼š

```java
@PostMapping("/refresh")
public Result<String> refreshToken(HttpServletRequest request) {
    String oldToken = extractToken(request);
    LoginUser loginUser = authenticator.authenticate(
        new HostAuthenticationToken(oldToken, extractDeviceId(request))
    );
    
    AuthenticationInfo authInfo = new AuthenticationInfo() {
        @Override
        public LoginUser getUser() {
            return loginUser;
        }
        
        @Override
        public String getCredential() {
            return extractDeviceId(request);
        }
    };
    
    String newToken = authenticator.login(authInfo);
    return Result.success(newToken);
}
```

### Q6: å¦‚ä½•è‡ªå®šä¹‰ Realmï¼Ÿ

**A**: å®ç° `Realm` æ¥å£å¹¶æ³¨å†Œä¸º Beanï¼š

```java
@Component
public class CustomRealm implements Realm {
    @Override
    public boolean support(AuthenticationToken token) {
        return token instanceof HostAuthenticationToken;
    }
    
    @Override
    public AuthenticationInfo getAuthenticationInfo(AuthenticationToken token) {
        // è‡ªå®šä¹‰é€»è¾‘
    }
}
```

### Q7: å¦‚ä½•ç¦ç”¨ Session ç®¡ç†ï¼Ÿ

**A**: åœ¨é…ç½®ä¸­è®¾ç½®ï¼š

```yaml
kite:
  auth:
    session:
      enabled: false
```

### Q8: Mock æ¨¡å¼å¦‚ä½•ä½¿ç”¨ï¼Ÿ

**A**: å¼€å‘ç¯å¢ƒå¯ä»¥å¯ç”¨ Mock æ¨¡å¼ï¼š

```yaml
kite:
  auth:
    mock-enabled: true
    mock-user-id: 1
    mock-username: test-user
```

å¯ç”¨åï¼Œæ‰€æœ‰è¯·æ±‚éƒ½ä¼šä½¿ç”¨ Mock ç”¨æˆ·ï¼Œæ— éœ€æä¾› Tokenã€‚

---

## æ€»ç»“

æœ¬è®¤è¯æ¨¡å—æä¾›äº†å®Œæ•´çš„è®¤è¯å’Œæƒé™æ§åˆ¶åŠŸèƒ½ï¼š

1. âœ… **JWT Token è®¤è¯**ï¼šæ— çŠ¶æ€ã€åˆ†å¸ƒå¼å‹å¥½
2. âœ… **Session ç®¡ç†**ï¼šæ”¯æŒå¤šè®¾å¤‡ã€å¼ºåˆ¶ä¸‹çº¿
3. âœ… **æƒé™æ§åˆ¶**ï¼šåŸºäºæ³¨è§£çš„æƒé™å’Œè§’è‰²æ§åˆ¶
4. âœ… **è‡ªåŠ¨é…ç½®**ï¼šSpring Boot Starterï¼Œå¼€ç®±å³ç”¨
5. âœ… **çµæ´»æ‰©å±•**ï¼šæ”¯æŒè‡ªå®šä¹‰ç»„ä»¶

é€šè¿‡æœ¬æ–‡æ¡£ï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š
- ç†è§£è®¤è¯æ¨¡å—çš„æ¶æ„è®¾è®¡
- æŒæ¡å„ä¸ªç»„ä»¶çš„èŒè´£å’Œä½¿ç”¨æ–¹æ³•
- å¿«é€Ÿé›†æˆè®¤è¯åŠŸèƒ½åˆ°è‡ªå·±çš„é¡¹ç›®
- è§£å†³å¸¸è§é—®é¢˜

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒæºç æˆ–æäº¤ Issueã€‚

